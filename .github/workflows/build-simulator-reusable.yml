name: Setup and Build for Simulator

on:
  workflow_call:
    inputs:
      simulator:
        description: 'Simulator name'
        required: false
        type: string
        default: 'iPhone 17'
      platform:
        description: 'Platform'
        required: false
        type: string
        default: 'iOS Simulator'
    outputs:
      app-path:
        description: "Path to the built .app"
        value: ${{ jobs.setup-build.outputs.app-path }}
      scheme:
        description: "The default scheme"
        value: ${{ jobs.setup-build.outputs.scheme }}

jobs:
  setup-build:
    runs-on: macos-latest
    outputs:
      app-path: ${{ steps.get-app-path.outputs.path }}
      scheme: ${{ steps.set-scheme.outputs.scheme }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: .github/scripts/install-dependencies.sh

      - name: Set Default Scheme
        id: set-scheme
        run: |
          .github/scripts/set-default-scheme.sh
          echo "scheme=$DEFAULT_SCHEME" >> $GITHUB_OUTPUT

      - name: Build App for Simulator
        env:
          PLATFORM: ${{ inputs.platform }}
          SIMULATOR: ${{ inputs.simulator }}
        run: .github/scripts/build-for-simulator.sh "$DEFAULT_SCHEME" "$PLATFORM" "$SIMULATOR"

      - name: Get App Path
        id: get-app-path
        run: |
          APP_PATH=$(find build/simulator/Build/Products/Debug-iphonesimulator -name "*.app" | head -n 1)
          echo "path=$APP_PATH" >> $GITHUB_OUTPUT
          echo "App path: $APP_PATH"

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: simulator-build
          path: build/simulator/Build/Products/Debug-iphonesimulator/*.app

